<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACR WebSocket Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2, h3 {
            color: #222;
        }
        
        .panel {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        
        .log-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .log-item:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #777;
        }
        
        .log-event {
            color: #2c7be5;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .event-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .event-type {
            padding: 6px 10px;
            background-color: #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .event-type.selected {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ACR WebSocket Demo</h1>
        
        <div class="panel">
            <h2>Connection</h2>
            <div class="status disconnected" id="connection-status">Disconnected</div>
            
            <div class="form-group">
                <label for="ws-url">WebSocket URL</label>
                <input type="text" id="ws-url" value="ws://localhost:1080/api/events" />
            </div>
            
            <div class="controls">
                <button id="connect-btn">Connect</button>
                <button id="disconnect-btn" disabled>Disconnect</button>
                <button id="clear-btn">Clear Log</button>
            </div>
            
            <h3>Subscribe to Players</h3>
            <div class="form-group">
                <label for="player-select">Select Players (leave empty for all)</label>
                <select id="player-select" multiple>
                    <option value="mpd">MPD</option>
                    <option value="spotify">Spotify</option>
                    <option value="raat">RAAT</option>
                </select>
            </div>
            
            <h3>Event Types</h3>
            <div class="event-selector" id="event-selector">
                <div class="event-type selected" data-event="state_changed">State Changed</div>
                <div class="event-type selected" data-event="song_changed">Song Changed</div>
                <div class="event-type selected" data-event="loop_mode_changed">Loop Mode</div>
                <div class="event-type selected" data-event="capabilities_changed">Capabilities</div>
                <div class="event-type" data-event="position_changed">Position</div>
                <div class="event-type selected" data-event="database_updating">Database</div>
            </div>
            
            <button id="update-subscription-btn" disabled>Update Subscription</button>
        </div>
        
        <div class="panel">
            <h2>Event Log</h2>
            <div class="log-container" id="log-container"></div>
        </div>
    </div>
    
    <script>
        // DOM Elements
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const clearBtn = document.getElementById('clear-btn');
        const wsUrl = document.getElementById('ws-url');
        const connectionStatus = document.getElementById('connection-status');
        const logContainer = document.getElementById('log-container');
        const playerSelect = document.getElementById('player-select');
        const eventSelector = document.getElementById('event-selector');
        const updateSubscriptionBtn = document.getElementById('update-subscription-btn');
        
        // WebSocket connection
        let socket = null;
        
        // Event Handlers
        connectBtn.addEventListener('click', connectWebSocket);
        disconnectBtn.addEventListener('click', disconnectWebSocket);
        clearBtn.addEventListener('click', clearLog);
        updateSubscriptionBtn.addEventListener('click', updateSubscription);
        
        // Click handler for event types
        document.querySelectorAll('.event-type').forEach(el => {
            el.addEventListener('click', () => {
                el.classList.toggle('selected');
            });
        });
        
        // Get color for player state
        function getStateColor(state) {
            switch(state) {
                case 'playing': return '#28a745'; // green
                case 'paused': return '#ffc107';  // yellow
                case 'stopped': return '#dc3545'; // red
                default: return '#6c757d';        // gray
            }
        }
        
        // Format time in seconds to MM:SS or HH:MM:SS
        function formatTime(seconds) {
            if (seconds === undefined || seconds === null) return '00:00';
            
            seconds = Math.floor(seconds);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        // Connect to WebSocket
        function connectWebSocket() {
            if (socket) {
                return;
            }
            
            const url = wsUrl.value;
            try {
                socket = new WebSocket(url);
                
                socket.onopen = () => {
                    setConnected(true);
                    logEvent('Connection established');
                    
                    // Send initial subscription with currently selected options
                    updateSubscription();
                };
                
                socket.onclose = (event) => {
                    logEvent(`Connection closed (code: ${event.code}, reason: ${event.reason || 'none'})`);
                    setConnected(false);
                };
                
                socket.onerror = (error) => {
                    logEvent(`WebSocket error: ${error}`);
                };
                
                socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    // Format message nicely for display
                    let message = '';
                    
                    if (data.type === 'welcome') {
                        message = `<b>Welcome:</b> ${data.message}`;
                        logEvent(message);
                        return;
                    }
                    
                    if (data.type === 'subscription_updated') {
                        message = `<span style="color: #28a745;"><b>✓</b> ${data.message}</span>`;
                        logEvent(message);
                        return;
                    }
                    
                    // Handle new format where event type is a key at the top level
                    const eventKey = Object.keys(data).find(key => 
                        key !== 'source' && typeof data[key] === 'object');
                    
                    if (eventKey) {
                        // This is the new format
                        const eventType = eventKey; // e.g., "StateChanged"
                        const eventData = data[eventKey]; // The event data
                        const source = data.source || {}; // Source at the top level
                        const playerName = source.player_name || 'unknown';
                        
                        message = `<span class="log-event">${eventType}</span> from <b>${playerName}</b>: `;
                        
                        // Format different event types appropriately
                        switch(eventType) {
                            case 'StateChanged':
                                message += `<span style="font-weight: bold; color: ${getStateColor(eventData.state)}">
                                    ${eventData.state || 'unknown'}</span>`;
                                break;
                                
                            case 'SongChanged':
                                if (eventData.song) {
                                    const song = eventData.song;
                                    message += `<div style="margin: 5px 0;">
                                        <div><b>Title:</b> ${song.title || 'Unknown'}</div>
                                        <div><b>Artist:</b> ${song.artist || 'Unknown'}</div>
                                        ${song.album ? `<div><b>Album:</b> ${song.album}</div>` : ''}
                                        ${song.duration ? `<div><b>Duration:</b> ${formatTime(song.duration)}</div>` : ''}
                                    </div>`;
                                } else {
                                    message += 'No song information';
                                }
                                break;
                                
                            case 'LoopModeChanged':
                                const mode = eventData.mode || 'unknown';
                                message += `Loop mode: <b>${mode}</b>`;
                                break;
                                
                            case 'CapabilitiesChanged':
                                if (eventData.capabilities) {
                                    const caps = eventData.capabilities;
                                    message += `<div style="margin: 5px 0;">
                                        <div><b>Capabilities:</b></div>
                                        ${caps.can_play !== undefined ? `<div>- Play: ${caps.can_play ? '✓' : '✗'}</div>` : ''}
                                        ${caps.can_pause !== undefined ? `<div>- Pause: ${caps.can_pause ? '✓' : '✗'}</div>` : ''}
                                        ${caps.can_toggle_play_pause !== undefined ? `<div>- Toggle play/pause: ${caps.can_toggle_play_pause ? '✓' : '✗'}</div>` : ''}
                                        ${caps.can_stop !== undefined ? `<div>- Stop: ${caps.can_stop ? '✓' : '✗'}</div>` : ''}
                                        ${caps.can_next !== undefined ? `<div>- Next: ${caps.can_next ? '✓' : '✗'}</div>` : ''}
                                        ${caps.can_previous !== undefined ? `<div>- Previous: ${caps.can_previous ? '✓' : '✗'}</div>` : ''}
                                    </div>`;
                                } else {
                                    message += 'No capability information';
                                }
                                break;
                                
                            case 'PositionChanged':
                                if (eventData.position !== undefined) {
                                    const position = eventData.position;
                                    const percentage = position.duration > 0 ? 
                                        Math.round((position.position / position.duration) * 100) : 0;
                                    
                                    message += `<div style="margin: 5px 0;">
                                        <div>${formatTime(position.position)} / ${formatTime(position.duration)} (${percentage}%)</div>
                                        <div style="width: 100%; background-color: #eee; height: 6px; border-radius: 3px; margin: 5px 0;">
                                            <div style="width: ${percentage}%; background-color: #007bff; height: 6px; border-radius: 3px;"></div>
                                        </div>
                                    </div>`;
                                } else {
                                    message += 'No position information';
                                }
                                break;
                                
                            case 'DatabaseUpdating':
                                const percentage = eventData.percentage !== undefined ? 
                                    Math.round(eventData.percentage * 100) : 0;
                                    
                                message += `<div style="margin: 5px 0;">
                                    <div>Database update: ${percentage}% complete</div>
                                    <div style="width: 100%; background-color: #eee; height: 6px; border-radius: 3px; margin: 5px 0;">
                                        <div style="width: ${percentage}%; background-color: #28a745; height: 6px; border-radius: 3px;"></div>
                                    </div>
                                </div>`;
                                break;
                                
                            default:
                                message += JSON.stringify(eventData);
                        }
                    } else {
                        // No need for backward compatibility as per your request
                        // For unknown event format, dump the complete JSON for debugging
                        message = `<span class="log-event">Unknown event format</span>: <pre style="margin: 5px 0; padding: 5px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow: auto; white-space: pre-wrap;">${JSON.stringify(data, null, 2)}</pre>`;
                    }
                    
                    logEvent(message);
                };
                
            } catch (error) {
                logEvent(`Failed to connect: ${error.message}`);
            }
        }
        
        // Disconnect from WebSocket
        function disconnectWebSocket() {
            if (socket) {
                socket.close();
                socket = null;
            }
        }
        
        // Set connected state
        function setConnected(isConnected) {
            if (isConnected) {
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                updateSubscriptionBtn.disabled = false;
            } else {
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                updateSubscriptionBtn.disabled = true;
                socket = null;
            }
        }
        
        // Clear log
        function clearLog() {
            logContainer.innerHTML = '';
        }
        
        // Log an event
        function logEvent(message) {
            const time = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logContainer.appendChild(logItem);
            
            // Scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Get event type as a string
        function getEventType(data) {
            if (data.state !== undefined) return 'StateChanged';
            if (data.song !== undefined) return 'SongChanged';
            if (data.mode !== undefined) return 'LoopModeChanged';
            if (data.capabilities !== undefined) return 'CapabilitiesChanged';
            if (data.position !== undefined) return 'PositionChanged';
            if (data.percentage !== undefined) return 'DatabaseUpdating';
            return 'Unknown';
        }
        
        // Update subscription
        function updateSubscription() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                return;
            }
            
            // Get selected players
            const players = Array.from(playerSelect.selectedOptions).map(option => option.value);
            
            // Get selected event types
            const eventTypes = Array.from(document.querySelectorAll('.event-type.selected'))
                .map(el => el.getAttribute('data-event'));
            
            // Create subscription object
            const subscription = {
                players: players.length > 0 ? players : null,
                event_types: eventTypes.length > 0 ? eventTypes : null
            };
            
            // Send subscription
            socket.send(JSON.stringify(subscription));
            logEvent(`Subscription updated: ${JSON.stringify(subscription)}`);
        }
    </script>
</body>
</html>